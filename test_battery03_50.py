"""
Battery of test03

These are tests generated by GPT-O

This script tests only that SQL syntax is correct. 
Ok if SQL can be executed on Oracle DB
"""

from tqdm import tqdm

from core_functions import (
    create_db_engine,
    get_formatted_schema,
    generate_sql_query_with_models,
    get_chat_models,
)
from utils import get_console_logger
from config_private import DB_USER

# SH schema
# Nome del file da leggere
# TESTS_FILE_NAME = "testsh50.txt"
TESTS_FILE_NAME = "testhr30.txt"

# Leggi il file riga per riga e carica ogni riga in una lista
with open(TESTS_FILE_NAME, "r", encoding="UTF-8") as file:
    USER_QUERIES = [linea.strip() for linea in file]


logger = get_console_logger()

logger.info("")
logger.info("Testing on schema: %s", DB_USER)
logger.info("")

# 0 is llama3-70B
model_list = get_chat_models()
llm1 = model_list[0]

engine = create_db_engine()

SCHEMA = get_formatted_schema(engine, llm1)

N_QUERIES = 0
N_OK = 0

for user_query in tqdm(USER_QUERIES):
    N_QUERIES += 1

    sql_query = generate_sql_query_with_models(user_query, SCHEMA, engine, model_list)

    # generate with pairs check the sintax
    # if sintax is wrong return empty string
    if len(sql_query) > 0:
        N_OK += 1

print("")
print("Summary of Test results:")
print("Number of queries: ", N_QUERIES)
print("Number of test ok: ", N_OK)
